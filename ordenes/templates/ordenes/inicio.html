<h1>Panel principal de gestión</h1>

<div style="display: flex; flex-direction: column; gap: 12px; max-width: 300px;">
  <button onclick="abrirModalOrdenes()">📋 Ver órdenes ingresadas</button>

  <button onclick="crearVentanaOrden()" style="width: 100%;">➕ Crear nueva orden de trabajo</button>

  <a href="{% url 'listar_equipos' %}">
    <button style="width: 100%;">📋 Ver lista de equipos</button>
  </a>

  <a href="{% url 'nuevo_equipo' %}">
    <button style="width: 100%;">➕ Cargar nuevo equipo</button>
  </a>

  <a href="{% url 'listar_clientes' %}">
    <button style="width: 100%;">👤 Ver clientes cargados</button>
  </a>

  <button disabled style="width: 100%; opacity: 0.5;">📊 Reportes (próximamente)</button>
  <button disabled style="width: 100%; opacity: 0.5;">🛠️ Diagnóstico técnico (próximamente)</button>
</div>

<div id="area-trabajo" style="margin-top: 20px;"></div>


<div id="modal-equipo" class="modal" style="display:none;">
  <div class="modal-contenido">
    <span class="cerrar" onclick="cerrarModal('equipo')">&times;</span>
    <div id="formulario-equipo"></div>
  </div>
</div>

<div id="modal-clientes" class="modal" style="display:none;">
  <div class="modal-contenido" style="max-height: 400px; overflow-y: auto;">
    <span class="cerrar" onclick="cerrarModalClientes()">&times;</span>
    <h3>📋 Clientes cargados</h3>
    <div id="lista-clientes">Cargando...</div>
  </div>
</div>


<script>
  let contadorVentanas = 0;

  function crearVentanaOrden() {
    contadorVentanas += 1;
    const idVentana = `orden-${contadorVentanas}`;

    const ventana = document.createElement('div');
    ventana.id = idVentana;
    ventana.style.border = '1px solid #ccc';
    ventana.style.margin = '10px 0';
    ventana.style.padding = '10px';
    ventana.style.background = '#f9f9f9';

    ventana.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong>Orden de trabajo #${contadorVentanas}</strong>
        <button onclick="cerrarVentana('${idVentana}')">✖ Cerrar</button>
      </div>
      <div class="contenido-orden">Cargando formulario...</div>
    `;

    document.getElementById('area-trabajo').appendChild(ventana);

    fetch('/ordenes/formulario/')
      .then(res => res.text())
      .then(html => {
        ventana.querySelector('.contenido-orden').innerHTML = html;
        activarAutocompletadoSerie(ventana);  // ← activamos el script
      });

  }

  function cerrarVentana(id) {
    const ventana = document.getElementById(id);
    if (ventana) ventana.remove();
  }

  function abrirModal(tipo) {
    const modal = document.getElementById(`modal-${tipo}`);
    modal.style.display = 'block';

    const contenedor = document.getElementById(`formulario-${tipo}`);
    if (contenedor) {
      fetch(`/${tipo}/formulario/`)
        .then(response => response.text())
        .then(html => {
          contenedor.innerHTML = html;
        });
    }
  }

  function cerrarModal(tipo) {
    document.getElementById(`modal-${tipo}`).style.display = 'none';
  }

  document.addEventListener('submit', function(e) {
  if (e.target && e.target.id === 'form-orden') {
    e.preventDefault();

    const form = e.target;
    const datos = new FormData(form);

    fetch('/ordenes/cliente/guardar/', {
  method: 'POST',
  headers: { 'X-CSRFToken': datos.get('csrfmiddlewaretoken') },
  body: datos
})

    .then(res => res.json())
    .then(data => {
      if (data.success) {
        form.closest('.contenido-orden').innerHTML = `<div style="color: green;">✅ Orden #${data.orden_id} guardada correctamente</div>`;
        setTimeout(() => {
          form.closest('.contenido-orden').parentElement.remove(); // Cierra la ventana
        }, 1500);
      } else {
        alert('Error al guardar la orden');
      }
    });
  }
});

document.addEventListener('input', function () {
  const clienteCampos = document.querySelectorAll('#form-completo input[name^="cliente"]');
  const equipoCampos = document.querySelectorAll('#form-completo input[name^="equipo"]');

  const clienteCompleto = Array.from(clienteCampos).every(c => c.value.trim() !== '');
  const equipoCompleto = Array.from(equipoCampos).every(e => e.value.trim() !== '');

  if (clienteCompleto && equipoCompleto) {
    document.getElementById('btn-guardar-orden').style.display = 'block';
  }
});

document.addEventListener('submit', function (e) {
  if (e.target.id === 'form-completo') {
    e.preventDefault();
    const datos = new FormData(e.target);

    fetch('/ordenes/guardar-completo/', {
      method: 'POST',
      headers: { 'X-CSRFToken': datos.get('csrfmiddlewaretoken') },
      body: datos
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        e.target.innerHTML = `<div style="color: green;">✅ Orden #${data.orden_id} generada correctamente</div>`;
        setTimeout(() => {
          e.target.closest('.contenido-orden').parentElement.remove();
        }, 2000);
      } else {
        alert('Error al guardar. Revisá los campos.');
      }
    });
  }
});

function abrirBuscadorClientes() {
  const modal = document.getElementById('modal-clientes');
  modal.style.display = 'block';

  fetch('/ordenes/clientes/listar/')
    .then(res => res.json())
    .then(data => {
      document.getElementById('lista-clientes').innerHTML = data.html;
    });
}

function abrirModalClientes() {
  document.getElementById('modal-clientes').style.display = 'block';
  fetch('/ordenes/clientes/listar/')
    .then(res => res.json())
    .then(data => {
      document.getElementById('lista-clientes').innerHTML = data.html;
    })
    .catch(err => {
      document.getElementById('lista-clientes').innerHTML = 'Error al cargar clientes.';
      console.error('Error al cargar clientes:', err);
    });
}

function cerrarModalClientes() {
  document.getElementById('modal-clientes').style.display = 'none';
}

function seleccionarCliente(nombre, telefono) {
  document.querySelector('input[name="nombre"]').value = nombre;
  document.querySelector('input[name="telefono"]').value = telefono;
  cerrarModalClientes();
}

function filtrarClientes() {
  const filtro = document.getElementById('busqueda-cliente').value.toLowerCase();
  const items = document.querySelectorAll('#clientes-lista li');
  items.forEach(item => {
    const nombre = item.getAttribute('data-nombre').toLowerCase();
    item.style.display = nombre.includes(filtro) ? 'block' : 'none';
  });
}


function cerrarModalClientes() {
  document.getElementById('modal-clientes').style.display = 'none';
}

function seleccionarCliente(nombre, telefono) {
  document.querySelector('input[name="nombre"]').value = nombre;
  document.querySelector('input[name="telefono"]').value = telefono;
  cerrarModalClientes();
}

const campoSerie = document.querySelector('input[name="numero_serie"]');

campoSerie.addEventListener('change', buscarEquipoPorSerie);
campoSerie.addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    e.preventDefault(); // evita que se envíe el formulario
    buscarEquipoPorSerie();
  }
});

function asignarValorCampo(contenedor, nombreCampo, valor) {
    const campo = contenedor.querySelector(`[name="${nombreCampo}"]`);
    if (!campo) return;

    if (campo.tagName === 'SELECT') {
      const existe = [...campo.options].some(opt => opt.value === valor);
      if (!existe) {
        const nuevaOpcion = document.createElement('option');
        nuevaOpcion.value = valor;
        nuevaOpcion.textContent = valor;
        campo.appendChild(nuevaOpcion);
      }
      campo.value = valor;
    } else {
      campo.value = valor;
    }
  }

function buscarEquipoPorSerie() {
  const serie = campoSerie.value.trim();
  if (serie.length === 0) return;

  fetch(`/ordenes/equipo/buscar/?numero_serie=${encodeURIComponent(serie)}`)
    .then(res => res.json())
    .then(data => {
      if (data.existe) {
        const eq = data.equipo;
        document.querySelector('input[name="imei"]').value = eq.imei;
        document.querySelector('input[name="tipo"]').value = eq.tipo;
        document.querySelector('input[name="marca"]').value = eq.marca;
        document.querySelector('input[name="modelo"]').value = eq.modelo;
        document.querySelector('textarea[name="accesorios"]').value = eq.accesorios;
        document.querySelector('textarea[name="estado_visual"]').value = eq.estado_visual;
        document.querySelector('textarea[name="falla_declarada"]').value = eq.falla_declarada;
        document.querySelector('input[name="fecha_compra"]').value = eq.fecha_compra;
        document.querySelector('input[name="en_garantia"]').checked = eq.en_garantia;
        document.querySelector('input[name="fuera_garantia_uso"]').checked = eq.fuera_garantia_uso;

        mostrarMensajeEquipoExistente();
      }
    });
}

function mostrarMensajeEquipoExistente() {
  let aviso = document.getElementById('aviso-equipo');
  if (!aviso) {
    aviso = document.createElement('div');
    aviso.id = 'aviso-equipo';
    aviso.style.color = 'green';
    aviso.style.marginTop = '10px';
    campoSerie.parentElement.appendChild(aviso);
  }
  aviso.textContent = '✅ Equipo ya registrado. Datos completados automáticamente.';
}

function activarAutocompletadoSerie(contenedor) {
  const campoSerie = contenedor.querySelector('input[name="numero_serie"]');
  if (!campoSerie) return;

  campoSerie.addEventListener('keydown', function (e) {
    if (e.key === 'Tab' || e.key === 'Enter') {
      setTimeout(() => buscarEquipoPorSerie(campoSerie), 100);
    }
  });
}

function buscarEquipoPorSerie(campoSerie) {
  const serie = campoSerie.value.trim();
  if (serie.length === 0) return;

  fetch(`/ordenes/equipo/buscar/?numero_serie=${encodeURIComponent(serie)}`)
    .then(res => res.json())
    .then(data => {
      if (data.existe) {
        const eq = data.equipo;
        const contenedor = campoSerie.closest('form');

        asignarValorCampo(contenedor, 'imei', eq.imei);
        asignarValorCampo(contenedor, 'tipo', eq.tipo);
        asignarValorCampo(contenedor, 'marca', eq.marca);
        asignarValorCampo(contenedor, 'modelo', eq.modelo);
        asignarValorCampo(contenedor, 'accesorios', eq.accesorios);
        asignarValorCampo(contenedor, 'estado_visual', eq.estado_visual);
        asignarValorCampo(contenedor, 'falla_declarada', eq.falla_declarada);
        asignarValorCampo(contenedor, 'fecha_compra', eq.fecha_compra);

        contenedor.querySelector('input[name="en_garantia"]').checked = eq.en_garantia;
        contenedor.querySelector('input[name="fuera_garantia_uso"]').checked = eq.fuera_garantia_uso;

        mostrarMensajeEquipoExistente(campoSerie);
      }
    });
}


function mostrarMensajeEquipoExistente(campoSerie) {
  let aviso = campoSerie.parentElement.querySelector('#aviso-equipo');
  if (!aviso) {
    aviso = document.createElement('div');
    aviso.id = 'aviso-equipo';
    aviso.style.color = 'green';
    aviso.style.marginTop = '10px';
    campoSerie.parentElement.appendChild(aviso);
  }
  aviso.textContent = '✅ Equipo ya registrado. Datos completados automáticamente.';
}

function abrirModalOrdenes() {
  document.getElementById('modal-ordenes').style.display = 'block';

  fetch('/ordenes/listar/')
    .then(res => res.json())
    .then(data => {
      document.getElementById('tabla-ordenes').innerHTML = data.html;
    })
    .catch(err => {
      document.getElementById('tabla-ordenes').innerHTML = 'Error al cargar órdenes.';
      console.error('Error al cargar órdenes:', err);
    });
}

function cerrarModalOrdenes() {
  document.getElementById('modal-ordenes').style.display = 'none';
}

</script>


<div id="modal-ordenes" style="
  display: none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border: 1px solid #ccc;
  padding: 20px;
  z-index: 1000;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  max-height: 500px;
  overflow-y: auto;
  width: 90%;
  max-width: 800px;
">
  <button onclick="cerrarModalOrdenes()" style="float: right;">✖</button>
  <h3>📋 Órdenes ingresadas</h3>
  <div id="tabla-ordenes">Cargando...</div>
</div>


<div id="modal-clientes" style="
  display: none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border: 1px solid #ccc;
  padding: 20px;
  z-index: 1000;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  max-height: 400px;
  overflow-y: auto;
">
  <button onclick="cerrarModalClientes()" style="float: right;">✖</button>
  <h3>📋 Buscar cliente</h3>
  <input type="text" id="busqueda-cliente" placeholder="Buscar por nombre..." oninput="filtrarClientes()" style="width: 100%; margin-bottom: 10px;">
  <div id="lista-clientes">Cargando...</div>
</div>

